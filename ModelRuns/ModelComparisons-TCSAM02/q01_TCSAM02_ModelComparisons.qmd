---
title: "Model Comparisons"
author: "William T. Stockhausen"
institute: "AFSC/NMFS/NOAA"
date: '`r format(Sys.time(), "%b %e, %Y")`'
fontsize: 11pt 
number-sections: true
number-depth: 3
reference-location: document
reference-section-title: References
bibliography: /Users/williamstockhausen/Work/Projects/Bibliography/AllRefs.bib
csl: '`r system.file("files/CJFAS.csl",package="wtsQMD")`'
link-citations: true
crossref:
  chapters: false      # prepend label reference numbers by chater number?
  fig-title: Figure    # for caption: default is "Figure")
  tbl-title: Table     # for caption: default is "Table")
  title-delim: "."     # for caption: default is ":")
  fig-prefix: Figure   # for in-text (use [-@fig-ref] to drop prefix in text)
  tbl-prefix: Table    # for in-text (use [-@tbl-ref] to drop prefix in text)
  fig-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  tbl-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  subref-labels: alpha a # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  ref-hyperlink: true    # references are hyperlinked if true
format: 
  html: 
    df-print: paged
    toc: true
    toc-location: right
    fig-width: 6.5
    fig-asp: 0.6
    fig-dpi: 100
    embed-resources: true
  pdf:
    documentclass: scrartcl
    toc: false
    fig_crop: false
    keep-tex: false
    fig-width: 6.5
    fig-asp: 0.6
    fig-dpi: 100
    geometry:
      - left=1.0in
      - right=1.0in
      - top=1.0in
      - bottom=1.0in
      - textwidth=6.5in
      - showframe=false
    include-in-header: 
      - text: |
          \usepackage{placeins}
          \extrafloats{500}
          \maxdeadcycles=10000
          \usepackage{fontspec}
          \usepackage{multicol}
          \usepackage{hhline}
          \newlength\Oldarrayrulewidth
          \newlength\Oldtabcolsep
      - file: '`r system.file("files/ltx_ExtraLatexIncludes.tex",package="wtsQMD")`'
echo: false
warning: false
results: 'hide'
keep-md: false
keep-yaml: false
editor: source
editor_options: 
  chunk_output_type: console
concordance: true
params:
  setup: !expr 'system.file("files/qmd_setup.R",package="wtsQMD")'
  testing: false
  reorderTables: false   #--issue with finding "range" of table values  (don't use)
  reorderFigures: false  #--issue with finding "range" of figure values (don't use)
---
<!-- IMPORTANT: if used as a child doc, all chunk labels must be unique within the overall document -->

<!-- 
  NOTEs: 
     * child_path$peek() gives path to current script.
     * before starting a child document, do 
         "child_path$push(file.path(child_path$peek(),rel_path))" first, 
         where rel_path is the relative path to the child
     * after a child document has finished, do "child_path$pop()" to return to current path value
-->

<!-- if not child doc, set up required objects -->
```{r}
#| label: TCSAM02_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
  testing = params$testing;
  if (testing) cat(params$setup,"\n\n")
  source(params$setup);
  if (testing) cat("root = ",root,"\n\n")
  reorderTables  = params$reorderTables;
  reorderFigures = params$reorderFigures;
```

```{r}
#| label: setup_TCSAM02
#| results: 'asis'
  require(ggplot2);
  require(kableExtra);
  require(tables);
  Sum = wtsUtilities::Sum;
  old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
                               cowplot::background_grid() +
                               cowplot::panel_border());
  thm = wtsPlots::getStdTheme();
  options("readr.show_col_types"=FALSE);
  if (testing) cat("dirThs =",child_path$peek(),"\n\n")
  #--NOTE: take out or modify the following as necessary
  if (!exists("s")){
    if (rstudioapi::isAvailable())
      fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
    if (child_path$peek()!="")
      fn = file.path(child_path$peek(),"../rda_AssessmentSetup.RData");
    #--for debugging: ;
    if (file.exists(fn)) s = wtsUtilities::getObj(fn);
  }
  asmtYr = 2024; #--s$asmtYr;
  #--
  dirThs = child_path$peek();                #--path to "this" folder
  if (rstudioapi::isAvailable()) dirThs = dirname(rstudioapi::getActiveDocumentContext()$path);
  dirPrj = file.path(child_path$peek(),"..");#--path to project folder from "this" folder
  if (!exists("tblno")) tblno = 0;
```

```{r TCSAM02-GetPlottingInfo}
legPosUR = ggplot2::theme(legend.position="inside",
                          legend.position.inside=c(0.99,0.99),
                         legend.justification.inside=c(1,1));
legPosUL = theme(legend.position="inside",
                 legend.position.inside=c(0.01,0.99),
                 legend.justification.inside=c(0,1));
legNone = ggplot2::theme(legend.position="none");
noTitle  = ggplot2::theme(plot.title=element_blank());
noXTitle = ggplot2::theme(axis.title.x=element_blank());

#--get plotting information----
  if (!exists("PLOT_OBJECTS")){
    #--PLOT OBJECTS---------------------------------------
    require(ggplot2);
    require(rCompTCMs);
    source(file.path(dirThs,"../RCode_Markdown/r_FigureFunctions.R"));
    std_theme = wtsPlots::getStdTheme();
    ggT = ggplot2::theme(plot.title=ggplot2::element_text(size=10,
                                                          margin=ggplot2::margin()),
                         panel.spacing = grid::unit(0.01,"in"),
                         legend.position="none", 
                         plot.margin=ggplot2::margin(0,0,0,1));
    ggL = ggplot2::labs(title=NULL,subtitle=NULL);
    noL  = theme(legend.position="none");
    noXT = theme(axis.title.x=element_blank());
    colour_scale=ggplot2::scale_color_hue();
    fill_scale  =ggplot2::scale_fill_hue();
    PLOT_OBJECTS = "PLOT_OBJECTS";#--make flag to prevent doing this again
  }
```

# TCSAM02 alternative models {#sec-TCSAM02} 

### Base model: 22.03d5

The model selected for the 2024 assessment, Model 22.03d5, provides the base model for the alternative models considered here. A detailed description of the model is given in @TannerCrab2024. The following three tables briefly summarize the parameterization and time blocks for the biological and fishery processes incorporated in this model:
 

```{r TCSAM02-tblModelDesc1,results='asis'}
  tblno = tblno+1;
  cap = paste0("Table ",LETTERS[tblno],". ",
               "Population processes and parameterization in the base model, 22.03d5.\n");
  cat(cap);
  fn = file.path(dirThs,"Tables_ModelDescription/ModDesc1")
  kbl = wtsQMD::imageAsKable(wtsQMD::getImageFN(fn));
  cat(kbl,"\n\n\n");
  rm(cap,kbl);
```

\newpage
```{r TCSAM02-tblModelDesc2,results='asis'}
  tblno = tblno+1;
  cap = paste0("Table ",LETTERS[tblno],". ",
               "Characteristics for retention and total catch in the directed (“TCF”) fishery ",
               "and bycatch in the snow crab (“SCF”) fishery in the base model, 22.03d5.\n");
  cat(cap);
  fn = file.path(dirThs,"Tables_ModelDescription/ModDesc2")
  kbl = wtsQMD::imageAsKable(wtsQMD::getImageFN(fn));
  cat(kbl,"\n\n\n");
  rm(cap,kbl);
```

\newpage
```{r TCSAM02-tblModelDesc3,results='asis'}
  tblno = tblno+1;
  cap = paste0("Table ",LETTERS[tblno],". ",
               "Characteristics for bycatch in the BBRKC (“RKF”) ",
               "and groundfish fisheries (“GF All”) in the base model, 22.03d5.\n")
  cat(cap);
  fn = file.path(dirThs,"Tables_ModelDescription/ModDesc3")
  kbl = wtsQMD::imageAsKable(wtsQMD::getImageFN(fn));
  cat(kbl,"\n\n\n");
  rm(cap,kbl);
```

\newpage
Unlike females, the maturity state of individual male Tanner crab is not readily identifiable in the field and is not provided as part of the annual NMFS EBS shelf survey datasets. Consequently, while data from the survey can be characterized by maturity state for females and treated differently in the likelihood depending on maturity state, this is not possible for males. Thus, the assessment model characterizes the NMFS EBS shelf survey data separately by sex, referring to the male-specific dataset (with no information on maturity state) as the "NMFS M" survey and the female-specific dataset (with females characterized as immature or mature based on abdominal shape) as the "NMFS F" survey. Similar conventions hold for survey data from BSFRF. The following table summarizes the parameterization and time blocks for the survey processes incorporated into 22.03d5.

```{r TCSAM02-tblModelDesc4,results='asis'}
  tblno = tblno+1;
  cap = paste0("Table ",LETTERS[tblno],". ",
               "Characteristics for the NMFS and BSFRF surveys in the base model, 22.03d5.\n")
  cat(cap);
  fn = file.path(dirThs,"Tables_ModelDescription/ModDesc4")
  kbl = wtsQMD::imageAsKable(wtsQMD::getImageFN(fn));
  cat(kbl,"\n\n\n");
  rm(cap,kbl);
```

\newpage
Finally, the components included in the model likelihood are summarized in the following table:

```{r TCSAM02-tblModelDesc5,results='asis'}
  tblno = tblno+1;
  cap = paste0("Table ",LETTERS[tblno],". ",
               "Likelihood components in the base model, 22.03d5.\n");
  cat(cap);
  fn = file.path(dirThs,"Tables_ModelDescription/ModDesc5")
  kbl = wtsQMD::imageAsKable(wtsQMD::getImageFN(fn));
  cat(kbl,"\n\n\n");
  rm(cap,kbl);
```

### Alternative models

Three models were considered as alternatives to 22.03d5 for the 2025 stock assessment. Every size composition in 22.03d5 had 5% compression applied to each tail prior to calculating the associated likelihood. Model 25_01 eliminated this compression. The observation errors associated with the aggregate survey biomass indices in 22.03d5 were assumed to be lognormally distributed, with the implication that model prediction errors for these data were scored on a relative scale (i.e., a 20% error at high observed biomass was scored the same as a 20% error at low observed biomass). Model 25_01a was built on 25_01 but assumed that observation errors in the survey biomass time series were normally distributed, with the implication that model prediction errors were scored on an absolute scale (thus, a 5t error at high biomass was scored the same as a 5t error at low biomass). 

Model 25_02 partially addresses an SSC request to drop the BSFRF side-by-side data from the model but use it to provide a prior on NMFS survey capture probabilities. Model 25_02 was also built on 25_01, but dropped fitting the BSFRF data and replaced estimating sex-specific NMFS survey selectivity curves and fully-selected catchability coefficients in the 1982-2024 time frame with sex-specific NMFS survey "capture probability" (fully-selected catchability $*$ size-specific selectivity) curves estimated from the BSFRF side-by-side haul studies ([@fig-TCSAM02-CapProbsSBS]). The estimated capture probabilities were based on the "survey level" analysis of the side-by-side data. However, the estimated curves suggest that capture probabilities are somewhat dome-shaped and decrease from maxima at intermediate sizes, although the uncertainty associated with these declines is very large due to the relatively small number of large crab caught in the surveys. Whether this tendency is real, and not an artifact of the data, seems unlikely. Consequently, the capture probability curves used in Model 25_02 were assumed to reach asymptotes at the maxima (the dotted lines in [@fig-TCSAM02-CapProbsSBS]). 

```{r}
#| label: fig_TCSAM02-CapProbsSBS
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1
  ##--SBS-derived NMFS capture probability functions----
  dirObj = "/Users/williamstockhausen/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/02_Empirical_Selectivity";
  obj = wtsUtilities::getObj(file.path(dirObj,"rda_EmpSelModels.RData"));
  dfrM = obj$males$best$prd;
  dfrF = obj$females$best$prd;

  sM = max(dfrM$emp_sel)
  zM = dfrM$z[dfrM$emp_sel==sM];
  dfrMp = dfrM |> dplyr::mutate(emp_sel=ifelse(z>zM,sM,emp_sel));
  sF = max(dfrF$emp_sel)
  zF = dfrF$z[dfrF$emp_sel==sF];
  dfrFp = dfrF |> dplyr::mutate(emp_sel=ifelse(z>zF,sF,emp_sel));
  dfrp = dplyr::bind_rows(
          dfrMp |> dplyr::mutate(sex="male"),
          dfrFp |> dplyr::mutate(sex="female")
        ) |> dplyr::mutate(se.fit=as.vector(se.fit)); #--se.fit is otherwise a list column
  
  p1 = ggplot(dfrp,aes(x=z,y=emp_sel,ymin=lci,ymax=uci,colour=sex,fill=sex)) +
        geom_line() + geom_ribbon(alpha=0.3) + 
        geom_line(data=dfrp,linetype=3,linewidth=1) + 
        labs(x="size (mm CW)",y="estimated selectivity");
  lbl = wtsQMD::getLabel();
  cap = paste0("Estimated sex/size-specific capture probability for the 1982+ NMFS EBS bottom trawl survey, ",
               "based on a survey-level analysis of the cooperative BSFRF/NMFS side-by-side haul data for Tanner crab.")
  pth = wtsQMD::getFigFN();
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p1+legPosUL,pth=pth,lbl=lbl,cap=cap,ori="P"));
 rm(obj,dfrM,dfrF,sM,zM,dfrMp,sF,zF,dfrFp,dfrp,p1,lbl,cap,pth)
```

The three alternative models appeared to converge to their maximum likelihood estimates (MLEs): maximum gradients for all three models were 0 after the ADMB "hess_step" procedure and standard errors were obtained for all estimated parameters (Table `r LETTERS[tblno+1]`). Parameter jittering was not attempted due to time limitations. Model 25_01a converged with a single parameter estimated at its (upper) bound, but the remaining alternative models converged with no parameters at a bound. Results for Model 22.03d5 were taken from the 2024 assessment. 

```{r TCSAM02-tblModelResults,results='asis'}
  tblno = tblno+1;
  cap = paste0("Table ",LETTERS[tblno],". ",
               "Convergence results for the TCSAM02 models.\n");
  cat(cap);
  fn = file.path(dirThs,"Tables_ModelDescription/AltModResults")
  kbl = wtsQMD::imageAsKable(wtsQMD::getImageFN(fn));
  cat(kbl,"\n\n\n");
  rm(cap,kbl);
```

Estimates of size-specific growth and probability of undergoing the molt to maturity were nearly identical for all models (Figure [-@fig-TCSAM02Mods-PopProcesses]). Estimates of natural mortality rates by sex and maturity stage were also very similar between the base model and 25_01, with slightly larger differences between it and the other two models (< 0.025, though).  

Large scale differences occurred among the models for estimated recruitment and mature biomass, with the largest estimates from Model 25_01a (~28% larger, on average after 1981), the smallest from 25_02 (~11% smaller); the base model and 25_01 had more similar estimates (25_01 on average ~6% larger; Figure [-@fig-TCSAM02-Rec]). For mature biomass, the differences between 25_01a and 25_02 and the other two models increased, with estimates from Mopdel 25_01a ~33% larger on average, and 25_02 ~28% smaller, than 22.03d5 (Figure [-@fig-TCSAM02-MatBio]). However, the estimated recruitment and mature biomass trends followed similar overall trajectories in all four models.

The estimated fully-selected fishery capture rates (not necessarily mortality) in the models exhibited essentially the same temporal behavior across the models, but differed somewhat in scale (Figure [-@fig-TCSAM02Mods-FshFs]). The scales generally exhibited the opposite relationship to those for recruitment and mature biomass: rates from 25_02 were generally higher than those from the base model but rates from 25_01a were generally lower. The estimated selectivity and curves (not shown) were extremely similar among the four models for all four fisheries, so the scales of the fishery capture rates, for a given fishery, were not related to differences in selectivity patterns among the models. 

The differences in the scales of recruitment, mature biomass, and fishing mortality appear to be directly related to the differences among the models in the estimates of NMFS survey capture probability (Figures [-@fig-TCSAM02-SrvSelM] and [-@fig-TCSAM02-SrvSelF]). Similar to the fully-selected fishing mortality rates, the capture probabilities are larger for 25_02 and smaller for 25_01a compared with the base, while the curves for 25_01 are very similar to the base.

The fits to fishery retained and total catch biomass are very good and display no significant differences among the models (Figure [-@fig-TCSAM02Mods-FshBioFits]). 

Given the difference in the scales of recruitment and mature biomass between 25_02, 25_01, and the base model, as well as the opposite (but offsetting) differences in NMFS survey capture probabilities, the degree of similarity in fits to NMFS survey biomass is somewhat surprising (Figures [-@fig-TCSAM02-SrvFitM] and [-@fig-TCSAM02-SrvFitF]). 25_02 has a small tendency to fit the NMFS survey biomass better than the base and 25_01 when the observed survey biomass is high (e.g.1988-1992), but otherwise the estimates are very similar. In contrast, estimates for NMFS survey biomass from 25_01a are almost always lower than the other three models; it also has the poorest performance following the semi-decadal fluctuations in observed survey biomass.

Residual diagnostics for NMFS survey size compositions (one-step ahead [OSA] residuals using the `afscOSA` R package) appear to be satisfactory for all of the models (Figures [-@fig-TCSAM02-OSAs-NMFS-M]- [-@fig-TCSAM02-OSAs-NMFS-F-mature]). Any differences between the models due to tail compression (22.03d5) or lack thereof (the alternative models) are not discernable. Some cohort effects are evident in the OSA residuals for males (e.g., the right-sloping band of positive residuals that start ~1980), but these are similar in the residuals for all the models. 

Residual diagnostics for fishery size compositions (Figures [-@fig-TCSAM02-OSAs-Fsh-TCF-male]-[-@fig-TCSAM02-OSAs-Fsh-RKF]) exhibit a consistent feature in the male size compositions in all fisheries  across all of the models: the mean proportions in the 50-75 mm carapace width (CW) range are underpredicted and in the 75-120 mm CW are overpredicted. This pattern may also occur in the female fishery size compositions, but to a much less notable degree. Interestingly, the SDNRs (Standard Deviation of Normalized Residuals) for the male compositions are, on the whole, much closer to 1 than the female compositions are, where 1 is the expected value if the OSAs were truly normally-distributed.

Of the three alternative TCSAM02 models evaluated here, only 25_02 may be worth considering for use in the 2025 assessment--although the case to be made is not particularly strong. "To tail compress or not to tail compress" does not seem to be an issue given the overall similarity in results between the base model and 25_01. Characterizing errors in fitting biomass trends using normal distributions and likelihoods is clearly a not a good choice to characterize Tanner crab survey data, given the inability of 25_01a to follow the semi-decadal swings in the NMFS survey biomass data. Model 25_02 demonstrates, more than anything else, I think, the uncertainty attached to overall scale in the Tanner crab survey data. This is apparent, as well, from the uncertainty intervals on the estimated curves (Figure [-@fig-TCSAM02-CapProbsSBS]) from which the capture probabilities used in 25_02 were derived.

```{r TCSAM02-GetModelResullts}
  #--get TCSAM02 models results----
  if (!exists("models"))
    models = wtsUtilities::getObj(file.path(dirThs,"rda_Models.RData"));
  compare  = names(models);
  obs_case = "22.03d5";
```


```{r}
#| label: fig-TCSAM02Mods-PopProcesses
#| fig-width: 9
#| fig-asp: 0.667
  #----natural mortality, mean growth, pr(M2M)----
  mdfr = rCompTCMs::extractMDFR.Pop.NaturalMortality(models,type="M_yxm") |> 
           dplyr::filter(y %in% c(2023,1983)) |> tidyr::pivot_wider(names_from="case",values_from="val")
  p1 = rCompTCMs::compareResults.Pop.NaturalMortality.BarPlot(models);
  p2 = rCompTCMs::compareResults.Pop.MeanGrowth(models,dodge=0)           +std_theme;
  p3 = rCompTCMs::compareResults.Pop.PrM2M(models,dodge=0,showPlot=FALSE) +std_theme;
  pg1 = cowplot::plot_grid(p2+ggplot2::theme(legend.position="none"),
                           p3+ggplot2::theme(legend.position="none"),ncol=1)
  pg2 = cowplot::plot_grid(plotlist = list(pg1,p1[[1]]),nrow=1); if (testing) print(pg2);
  cap = paste0("Estimated population processes from the TCSAM02 models. ",
               "Plots in upper lefthand quadrant: sex-specific mean growth; ",
               "plots in lower lefthand quadrant: sex-specific probability of the ",
               "molt-to-maturity (i.e., terminal molt); ",
               "plots in righthand column: natural mortality rates, ",
               "by maturity state and sex.");
  xt  = paste0("dummy");
  lbl = wtsQMD::getLabel();
  pth = wtsQMD::getFigFN();
  lstFigs = c(lstFigs,wtsQMD::printGGplot(pg2,lbl=lbl,cap=cap,pth=pth,ori="L"));
  rm(p1,p2,p3,pg1,pg2,cap,xt,lbl,cap,pth);
```

<!-- ```{r} -->
<!-- #| label: fig-TCSAM02Mods-RecMMB -->
<!-- #| fig-width: 9 -->
<!-- #| fig-asp: 0.667 -->
<!--   #--recruitment and mature biomass---- -->
<!--   ##--all years---- -->
<!--   ps1 =  rCompTCMs::compareResults.Pop.Recruitment(models,dodge=0,numRecent=20,plotPoints=TRUE); -->
<!--   ps2 =  rCompTCMs::compareResults.Pop.MatureBiomass(models,dodge=0,numRecent=20); -->
<!--   lg = cowplot::get_legend(ps1[[1]] + guides(shape="none")); -->
<!--   p1 = ps1[[1]] + ggL + ggT + theme(legend.position="none") + std_theme; -->
<!--   p2 = ps2[[1]] + ggL + ggT + theme(legend.position="none") + std_theme; -->
<!--   pg1 = cowplot::plot_grid(plotlist=list(p1,p2),ncol=1,rel_heights=c(1,1)) -->
<!--   pg2 = cowplot::plot_grid(pg1,lg,ncol=2,rel_widths=c(10,2)); if (testing) print(pg2); -->
<!--   cap = paste0("TCSAM02 models estimated recruitment and mature biomass time series (all years). ", -->
<!--                "Upper plot: recruitment; ", -->
<!--                "lower plots: sex-specific mature biomass-at-mating."); -->
<!--   xt  = paste0("dummy"); -->
<!--   lbl = wtsQMD::getLabel(); -->
<!--   pth = wtsQMD::getFigFN(); -->
<!--   lstFigs = c(lstFigs,wtsQMD::printGGplot(pg2,lbl=lbl,cap=cap,pth=pth,ori="L")); -->
<!--   # lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=9,hgt=6,dpi=def_dpi,ori="L"); -->
<!--   # ggsave(pth,plot=pg2,width=9,height=6,units="in",dpi=def_dpi); -->
<!--   ##--recent years---- -->
<!--   p1 = ps1[[2]] + ggL +ggT + theme(legend.position="none") + std_theme; -->
<!--   p2 = ps2[[2]] + ggL +ggT + theme(legend.position="none") + std_theme; -->
<!--   pg1 = cowplot::plot_grid(plotlist=list(p1,p2),ncol=1,rel_heights=c(1,1)) -->
<!--   pg2 = cowplot::plot_grid(pg1,lg,ncol=2,rel_widths=c(10,2)); if (testing) print(pg2); -->
<!--   cap = paste0("TCSAM02 models estimated recruitment and mature biomass time series (recent years). ", -->
<!--                "Upper plot: recruitment; ", -->
<!--                "lower plots: sex-specific mature biomass-at-mating."); -->
<!--   xt  = paste0("-RctYrs"); -->
<!--   lbl = wtsQMD::getLabel(xt); -->
<!--   pth = wtsQMD::getFigFN(xt); -->
<!--   lstFigs = c(lstFigs,wtsQMD::printGGplot(pg2,lbl=lbl,cap=cap,pth=pth,ori="L")); -->
<!--   # lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=9,hgt=6,dpi=def_dpi,ori="L"); -->
<!--   # ggsave(pth,plot=pg2,width=9,height=6,units="in",dpi=def_dpi); -->
<!--   rm(ps1,ps2,lg,p1,p2,pg1,pg2,xt,lbl,cap,pth); -->
<!-- ``` -->

```{r TCSAM02-GetRec-MatBio}
##--recruitment and mature biomass--------------------------------------------
mdfr<-rCompTCMs::extractMDFR.SdRep.RecAndSSB(models);
mdfrp = mdfr |> dplyr::filter(name=="sdrLnR_y", y>1981) |> 
                dplyr::select(case,y,est) |> 
                dplyr::mutate(est=exp(est)) |> 
                tidyr::pivot_wider(names_from="case",values_from="est") |> 
                  dplyr::mutate(`01`=100*(`25_01`/`22.03d5`-1),
                                `01a`=100*(`25_01a`/`22.03d5`-1),
                                `02`=100*(`25_02`/`22.03d5`-1)) |> 
                dplyr::summarize(`01`=mean(`01`),
                                 `01a`=mean(`01a`),
                                 `02`=mean(`02`)) 
mdfrp = mdfr |> dplyr::filter(name=="sdrSpB_xy", y>1981) |> 
                dplyr::select(case,y,x,est) |> 
                tidyr::pivot_wider(names_from=c("case","x"),values_from="est") |> 
                  dplyr::mutate(`01_male`=100*(`25_01_male`/`22.03d5_male`-1),
                                `01a_male`=100*(`25_01a_male`/`22.03d5_male`-1),
                                `02_male`=100*(`25_02_male`/`22.03d5_male`-1),
                                `01_female`=100*(`25_01_female`/`22.03d5_female`-1),
                                `01a_female`=100*(`25_01a_female`/`22.03d5_female`-1),
                                `02_female`=100*(`25_02_female`/`22.03d5_female`-1)) |> 
                dplyr::summarize(`01_male`=mean(`01_male`),
                                 `01a_male`=mean(`01a_male`),
                                 `02_male`=mean(`02_male`),
                                 `01_female`=mean(`01_female`),
                                 `01a_female`=mean(`01a_female`),
                                 `02_female`=mean(`02_female`)) 
plts<-rCompTCMs::compareResults.sdRep.RecAndSSB(models);
rm(mdfr,mdfrp)
```

```{r}
#| label: fig_TCSAM02-Rec
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1.4
##--combined sex----
pg = cowplot::plot_grid(plts$plts$rec[[1]] + scale_y_continuous(limits=c(0,20000),oob=scales::oob_squish) + 
                          legPosUR + noTitle + noXTitle,
                        plts$plts$rec[[2]] + legNone + noTitle + noXTitle,ncol=1);
lbl = wtsQMD::getLabel();
cap = paste0("Estimated recruitment trends from the TCSAM02 models. ",
             "Fills indicate confidence intervals.")
pth = wtsQMD::getFigFN();

lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P"));
rm(pg,lbl,cap,pth);
```

```{r}
#| label: fig_TCSAM02-MatBio
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1.4
##--combined sex----
pg = cowplot::plot_grid(plts$plts$ssb[[1]] +  
                          legPosUR + noTitle + noXTitle,
                        plts$plts$ssb[[2]] + legNone + noTitle + noXTitle,ncol=1);
lbl = wtsQMD::getLabel();
cap = paste0("Estimated mature biomass trends from the TCSAM02 models. ",
             "Fills indicate confidence intervals.")
pth = wtsQMD::getFigFN();

lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P"));
rm(pg,lbl,cap,pth,plts);
```

<!-- ```{r} -->
<!-- #| label: fig-TCSAM02Mods-PopAbd -->
<!-- #| fig-width: 6.5 -->
<!-- #| fig-asp: 1.2 -->
<!--   #--population abundance---- -->
<!--   ps = rCompTCMs::compareResults.Pop.Abundance(models,cast="x+m", -->
<!--                                                dodge=0,years="all", -->
<!--                                               facet_grid=x+m~.,scales="free_y"); -->
<!--   lg = wtsPlots::getLegend(ps[[1]] + guides(shape="none"),return_all=TRUE); -->
<!--   p1 = ps[[1]] + ggL + ggT +  -->
<!--          theme(legend.position="none",axis.title.x=element_blank()) + -->
<!--          std_theme; -->
<!--   ps = rCompTCMs::compareResults.Pop.Abundance(models, -->
<!--                                                cast="x+m",dodge=0, -->
<!--                                                years=2000:asmtYr, -->
<!--                                                facet_grid=x+m~.,scales="free_y"); -->
<!--   p2 = ps[[1]] + ggL + ggT + theme(legend.position="none") + std_theme; -->
<!--   pg1 = cowplot::plot_grid(plotlist=list(p1,p2),ncol=1,rel_heights=c(1,1)) -->
<!--   pg2 = cowplot::plot_grid(plotlist=list(pg1,lg[[1]]),ncol=2,rel_widths=c(10,2)); if (testing) print(pg2); -->
<!--   cap = paste0("TCSAM02 models estimated population abundance trends, by sex and maturity state. ", -->
<!--                "Upper plots: all years; ", -->
<!--                "lower plots: recent years."); -->
<!--   xt  = paste0("dummy"); -->
<!--   lbl = wtsQMD::getLabel(); -->
<!--   pth = wtsQMD::getFigFN(); -->
<!--   lstFigs = c(lstFigs,wtsQMD::printGGplot(pg2,lbl=lbl,cap=cap,pth=pth,ori="P")); -->
<!--   # lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=6.5,hgt=8.5,dpi=def_dpi,ori="P"); -->
<!--   # ggsave(pth,plot=pg2,width=6.5,height=8.5,units="in",dpi=def_dpi); -->
<!--   rm(lg,p1,ps,p2,pg1,pg2,xt,lbl,cap,pth); -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig-TCSAM02Mods-PopBio -->
<!-- #| fig-width: 6.5 -->
<!-- #| fig-asp: 1.2 -->
<!--   #--population biomass---- -->
<!--   ps = rCompTCMs::compareResults.Pop.Biomass(models,cast="x+m", -->
<!--                                                dodge=0,years="all", -->
<!--                                               facet_grid=x+m~.,scales="free_y"); -->
<!--   lg = wtsPlots::getLegend(ps[[1]] + guides(shape="none"),return_all=TRUE); -->
<!--   p1 = ps[[1]] + ggL + ggT +  -->
<!--          theme(legend.position="none",axis.title.x=element_blank()) + -->
<!--          std_theme; -->
<!--   ps = rCompTCMs::compareResults.Pop.Biomass(models[compare], -->
<!--                                                cast="x+m",dodge=0, -->
<!--                                                years=2000:asmtYr, -->
<!--                                                facet_grid=x+m~.,scales="free_y"); -->
<!--   p2 = ps[[1]] + ggL + ggT + theme(legend.position="none") + std_theme; -->
<!--   pg1 = cowplot::plot_grid(plotlist=list(p1,p2),ncol=1,rel_heights=c(1,1)) -->
<!--   pg2 = cowplot::plot_grid(pg1,lg[[1]],ncol=2,rel_widths=c(10,2)); if (testing) print(pg2); -->
<!--   cap = paste0("TCSAM02 models estimated population biomass trends, by sex and maturity state. ", -->
<!--                "Upper plots: all years; ", -->
<!--                "lower plots: recent years."); -->
<!--   xt  = paste0("dummy"); -->
<!--   lbl = wtsQMD::getLabel(); -->
<!--   pth = wtsQMD::getFigFN(); -->
<!--   lstFigs = c(lstFigs,wtsQMD::printGGplot(pg2,lbl=lbl,cap=cap,pth=pth,ori="P")); -->
<!--   # lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=6.5,hgt=8.5,dpi=def_dpi,ori="P"); -->
<!--   # ggsave(pth,plot=pg2,width=6.5,height=8.5,units="in",dpi=def_dpi); -->
<!--   rm(lg,p1,ps,p2,pg1,pg2,xt,lbl,cap,pth); -->
<!-- ``` -->


```{r}
#| label: fig_TCSAM02Mods-FshFs
#| fig-asp: 1.23
#| results: asis
  ##--directed fishery----
  fleet_="TCF";
  ##--fully-selected capture rates----
  mdfr= rCompTCMs::extractMDFR.Fisheries.Catchability(models,
                                                      fleets=fleet_,
                                                      cast="x") |> dplyr::filter(x=="male",y>1990)
  ps1 = rCompTCMs::compareResults.Fisheries.Catchability(mdfr=mdfr,
                                                         fleets=fleet_,
                                                         cast="x",
                                                         facet_grid=.~x,
                                                         years="all");
 ##--snow crab fishery----
  fleet_="SCF";
  mdfr= rCompTCMs::extractMDFR.Fisheries.Catchability(models,
                                                      fleets=fleet_,
                                                      cast="x") |> dplyr::filter(x=="male",y>1990)
  ps2 = rCompTCMs::compareResults.Fisheries.Catchability(mdfr=mdfr,
                                                        fleets=fleet_,
                                                        cast="x",
                                                        facet_grid=.~x,
                                                        years="all");
  ##--BBRKC fishery----
  fleet_="RKF";
  mdfr= rCompTCMs::extractMDFR.Fisheries.Catchability(models,
                                                      fleets=fleet_,
                                                      cast="x") |> dplyr::filter(x=="male",y>1990)
  ps3 = rCompTCMs::compareResults.Fisheries.Catchability(mdfr=mdfr,
                                                        fleets=fleet_,
                                                        cast="x",
                                                        facet_grid=.~x,
                                                        years="all");
  ##--groundfish fisheries----
  fleet_="GF All";
  mdfr= rCompTCMs::extractMDFR.Fisheries.Catchability(models,
                                                      fleets=fleet_,
                                                      cast="x") |> dplyr::filter(x=="male",y>1990)
  ps4 = rCompTCMs::compareResults.Fisheries.Catchability(mdfr=mdfr,
                                                        fleets=fleet_,
                                                        cast="x",
                                                        facet_grid=.~x,
                                                        years="all");
  pg1 = cowplot::plot_grid(ps1[[1]] + noXTitle + legPosUR +theme(title=element_text(size=8)),
                           ps2[[1]] + noXTitle + legNone +theme(title=element_text(size=8)),
                           ps3[[1]] + noXTitle + legNone +theme(title=element_text(size=8)),
                           ps4[[1]] + noXTitle + legNone +theme(title=element_text(size=8)),ncol=1);
  cap = paste0("Estimated fully-selected capture rates (not mortality) for male Tanner crab ",
               "in the directed and bycatch fisheries from the TCSAM02 models. ",
               "TCF: directed Tanner crab fishery; SCF: snow crab fishery; RKF: BBRKC fishery; ",
               "GF All: all groundfish fisheries.");
  lbl = wtsQMD::getLabel();
  pth = wtsQMD::getFigFN();
  lstFigs = c(lstFigs,wtsQMD::printGGplot(pg1,lbl=lbl,cap=cap,pth=pth,ori="P"));
  rm(fleet_,mdfr,ps1,ps2,ps3,ps4,pg1,cap,lbl,pth)
```


```{r TCSAM02-getCaptureProbs}
  ##--NMFS survey capture probabilities----
  mdfr = rCompTCMs::extractMDFR.Surveys.CaptureProbs(models) |> 
          dplyr::filter(y %in% c(1975,1982),z==182) |> 
                dplyr::select(case,y,x,val) |> 
                tidyr::pivot_wider(names_from=c("case","x"),values_from="val") |> 
                dplyr::mutate(`01_male`=100*(`25_01_male`/`22.03d5_male`-1),
                              `01a_male`=100*(`25_01a_male`/`22.03d5_male`-1),
                              `02_male`=100*(`25_02_male`/`22.03d5_male`-1),
                              `01_female`=100*(`25_01_female`/`22.03d5_female`-1),
                              `01a_female`=100*(`25_01a_female`/`22.03d5_female`-1),
                              `02_female`=100*(`25_02_female`/`22.03d5_female`-1)) |> 
                dplyr::summarize(`01_male`=mean(`01_male`),
                                 `01a_male`=mean(`01a_male`),
                                 `02_male`=mean(`02_male`),
                                 `01_female`=mean(`01_female`),
                                 `01a_female`=mean(`01a_female`),
                                 `02_female`=mean(`02_female`)) 
  plts = rCompTCMs::compareResults.Surveys.CaptureProbs(models,
                                                        cast="y+x",
                                                        fleets=c("NMFS M","NMFS F"),
                                                        years=c(1975,1982));
```

```{r}
#| label: fig_TCSAM02-SrvSelM
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1
  ##--NMFS survey capture probabilities for male crab----
  lbl = wtsQMD::getLabel();
  cap = paste0("Estimated size-specific capture probability for male Tanner crab in the NMFS EBS bottom trawl survey from the TCSAM02 models. ",
               "Estimated curves are applied in two time periods: 1975: 1975-1981; 1982; 1982+.")
  pth = wtsQMD::getFigFN();
  lstFigs = c(lstFigs,wtsQMD::printGGplot(plts[[1]]+legPosUL,pth=pth,lbl=lbl,cap=cap,ori="P"));
  rm(pg,lbl,cap,pth);
```

```{r}
#| label: fig_TCSAM02-SrvSelF
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1
  ##--NMFS survey capture probabilities for female crab----
  lbl = wtsQMD::getLabel();
  cap = paste0("Estimated size-specific capture probability for female Tanner crab in the NMFS EBS bottom trawl survey from the TCSAM02 models. ",
               "Estimated curves are applied in two time periods: 1975: 1975-1981; 1982; 1982+.")
  pth = wtsQMD::getFigFN();
  legPosUL = theme(legend.position="inside",
                   legend.position.inside=c(0.01,0.99),
                   legend.justification.inside=c(0,1));
  lstFigs = c(lstFigs,wtsQMD::printGGplot(plts[[2]]+legPosUL,pth=pth,lbl=lbl,cap=cap,ori="P"));
  rm(pg,lbl,cap,pth);
```

```{r}
#| label: fig_TCSAM02Mods-FshBioFits
#| fig-width: 6
#| fig-asp: 1.3
  #--fits to retained and total catch and in the directed and bycatch fisheries----
  p1 = rCompTCMs::compareFits.BiomassData(models,fleets="TCF",
                                                  fleet.type="fishery",catch.type="retained",
                                                  fishery.pdf="lognormal")[[2]];
  p2 = rCompTCMs::compareFits.BiomassData(models,fleets="TCF",
                                                  fleet.type="fishery",catch.type="total",
                                                  fishery.pdf="lognormal")[[2]];
  p3 = rCompTCMs::compareFits.BiomassData(models,fleets="SCF",
                                                  fleet.type="fishery",catch.type="total",
                                                  fishery.pdf="lognormal")[[2]];
  p4 = rCompTCMs::compareFits.BiomassData(models,fleets="RKF",
                                                  fleet.type="fishery",catch.type="total",
                                                  fishery.pdf="lognormal")[[2]];
  p5 = rCompTCMs::compareFits.BiomassData(models,fleets="GF All",
                                                  fleet.type="fishery",catch.type="total",
                                                  fishery.pdf="lognormal")[[2]];
  pg = cowplot::plot_grid(p1 + noXTitle + legPosUR + theme(title=element_text(size=8)),
                          p2 + noXTitle + legNone + theme(title=element_text(size=8)),
                          p3 + noXTitle + legNone + theme(title=element_text(size=8)),
                          p4 + noXTitle + legNone + theme(title=element_text(size=8)),
                          p5 + noXTitle + legNone + theme(title=element_text(size=8)),
                          ncol=1)
  cap = paste0("Fits to retained and total catch biomass in the directed fishery and bycatch fisheries.",
               "Vertical bars indicate assumed confidence intervals on the catch data. ",
               "Points: data (labelled as 22.03d5, but same for all models); lines: model fits.");
  lbl = wtsQMD::getLabel();
  pth = wtsQMD::getFigFN();
  lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,lbl=lbl,cap=cap,pth=pth,ori="P"));
  rm(p1,p2,p3,p4,pg,lbl,cap,pth);
```

```{r TCSAM02-GetSurveyBiomassFits}
##--surveys (biomass)--------------------------------------------
plts<-rCompTCMs::compareFits.BiomassData(objs=models,
                                         fleets=c("NMFS M",
                                                  "NMFS F",
                                                  "SBS BSFRF M",
                                                  "SBS BSFRF F"),
                                         fleet.type="survey",
                                         catch.type="index",
                                         ci=0.95);
```

```{r}
#| label: fig_TCSAM02-SrvFitM
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1.2
##--NMFS survey males----
pg = cowplot::plot_grid(plts[[2]] + legPosUR + noTitle + noXTitle,
                        plts[[3]] + legNone + noTitle + noXTitle,ncol=1);
lbl = wtsQMD::getLabel();
cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to NMFS survey biomass ",
             "for males. Points and bars indicate the design-based estimates and confidence intervals. ",
             "Points and vertical lines: data and confidence intervals (labelled as 22.03d5, but same for all models); ",
             "lines: model fits.");
pth = wtsQMD::getFigFN();

lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P"));
rm(pg,lbl,cap,pth);
```

```{r}
#| label: fig_TCSAM02-SrvFitF
#| results: "asis"
#| fig-width: 6.0
#| fig-asp: 1.4
##--NMFS survey females----
pg = cowplot::plot_grid(plts[[5]] + legPosUR + noTitle + noXTitle,
                        plts[[6]] + legNone + noTitle + noXTitle,ncol=1);
lbl = wtsQMD::getLabel();
cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to NMFS survey biomass ",
             "for females. Points and bars indicate the design-based estimates and confidence intervals. ",
             "Points and vertical lines: data and confidence intervals (labelled as 22.03d5, but same for all models); ",
             "lines: model fits.")
pth = wtsQMD::getFigFN();

lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P"));
rm(pg,lbl,cap,pth);
```

```{r}
# #| label: fig_TCSAM02-SrvFitBSFRF
# #| results: "asis"
# #| fig-width: 6.0
# #| fig-asp: 1.4
# ##--females----
# pg = cowplot::plot_grid(plts[[8]] + legPosUR + noTitle + noXTitle,
#                         plts[[11]] + legNone + noTitle + noXTitle,ncol=1);
# lbl = wtsQMD::getLabel();
# cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to BSFRF survey biomass.",
#              "Points and bars indicate the design-based estimates and confidence intervals. ",
#              "Note that model 25_02 does not include the BSFRF data in it's likelihood.")
# pth = wtsQMD::getFigFN();
# 
# lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P"));
# rm(pg,lbl,cap,pth,plts);
```

```{r fig_TCSAM02-OSAs-NMFS-M}
#| fig-width: 9
#| fig-asp: 0.667
  ##--OSA residuals for NMFS survey data
  cases1 = names(models)
  fltnms = c("NMFS M"="NMFS-M");
  for (flt in c("NMFS M")){
    #--testing: flt = "NMFS M";
    fltnm = fltnms[flt];
    mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets=flt,
                                            fleet.type="survey",catch.type='index',
                                            plot1stObs=FALSE); 
    mdfr2 = rCompTCMs::extractMDFR.Fits.EffectiveNs(models,fleets=flt,
                                                   fleet.type="survey",category="index")
    obss = mdfr1 |> dplyr::filter(type=="observed") |> dplyr::select(case,y,z,val) |> 
             tidyr::pivot_wider(names_from=z,values_from="val");
    prds = mdfr1 |> dplyr::filter(type=="predicted") |> dplyr::select(case,y,z,val) |> 
             tidyr::pivot_wider(names_from=z,values_from="val");
    Ns = mdfr2 |> dplyr::filter(type=="input ss") |> dplyr::select(case,y,val)
    lst = list();
    for (case_ in cases1){
      #--case_=cases1[1]
      ys  = (obss |> dplyr::filter(case==case_) |> dplyr::select(y))$y;
      obs=as.matrix(obss |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
      names(obs) = ys;
      prd = as.matrix(prds |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
      prd = prd+1.0e-5;
      N   = (Ns   |> dplyr::filter(case==case_) |> dplyr::select(val))$val;
      zs  = as.numeric(colnames(obs));
      res = afscOSA::run_osa(obs,prd,N=N,fleet=case_,index=zs,years=ys,index_label="size (mm CW)");
      lst[[case_]] = res;
    }
    p   = afscOSA::plot_osa(lst)[[1]];
    cap = paste0("OSA residuals for TCSAM02 models' fits to male size compositions from the NMFS survey. ",
                 "The base model is 22.03d5.");
    xt  = paste0("");
    lbl = wtsQMD::getLabel(xt);
    pth = wtsQMD::getFigFN(xt);
    lstFigs = c(lstFigs,wtsQMD::printGGplot(p,lbl=lbl,cap=cap,pth=pth,ori="L"));
  }#--flt loop
```

```{r fig_TCSAM02-OSAs-NMFS-F-}
#| fig-width: 9
#| fig-asp: 0.667
  ##--OSA residuals for NMFS survey data
  cases1 = names(models)
  fltnms = c("NMFS F"="NMFS-F");
  for (flt in c("NMFS F")){
    #--testing: flt = "NMFS F";
    fltnm = fltnms[flt];
    mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets=flt,
                                            fleet.type="survey",catch.type='index',
                                            plot1stObs=FALSE); 
    mdfr2 = rCompTCMs::extractMDFR.Fits.EffectiveNs(models,fleets=flt,
                                                   fleet.type="survey",category="index");
    for (m_ in c("immature","mature")){
      obss = mdfr1 |> dplyr::filter(type=="observed",m==m_) |> dplyr::select(case,y,z,val) |> 
               tidyr::pivot_wider(names_from=z,values_from="val");
      prds = mdfr1 |> dplyr::filter(type=="predicted",m==m_) |> dplyr::select(case,y,z,val) |> 
               tidyr::pivot_wider(names_from=z,values_from="val");
      Ns = mdfr2 |> dplyr::filter(type=="input ss",m==m_) |> dplyr::select(case,y,val)
      lst = list();
      for (case_ in cases1){
        #--case_=cases1[1]
        ys  = (obss |> dplyr::filter(case==case_) |> dplyr::select(y))$y;
        obs=as.matrix(obss |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
        names(obs) = ys;
        prd = as.matrix(prds |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
        prd = prd+1.0e-5;
        N   = (Ns   |> dplyr::filter(case==case_) |> dplyr::select(val))$val;
        zs  = as.numeric(colnames(obs));
        res = afscOSA::run_osa(obs,prd,N=N,fleet=case_,index=zs,years=ys,index_label="size (mm CW)");
        lst[[case_]] = res;
      }
      p   = afscOSA::plot_osa(lst)[[1]];
      cap = paste0("OSA residuals for TCSAM02 models' fits to ",m_," female size compositions from the ",
                   " NMFS survey. ",
                   "The base model is 22.03d5.");
      xt  = paste0(m_);
      lbl = wtsQMD::getLabel(xt);
      pth = wtsQMD::getFigFN(xt);
      lstFigs = c(lstFigs,wtsQMD::printGGplot(p,lbl=lbl,cap=cap,pth=pth,ori="L"));
    }#--maturity loop
  }#--flt loop
```

```{r fig_TCSAM02-OSAs-Fsh-}
#| fig-width: 9
#| fig-asp: 0.667
  ##--OSA residuals for fishery data
  cases1 = names(models)
  fltnms = c("TCF"="TCF","SCF"="SCF","RKF"="RKF","GF All"="GFA");
  for (flt in c("TCF","SCF","GF All")){
    #--testing: flt = "TCF";
    fltnm = fltnms[flt];
    mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets=flt,
                                            fleet.type="fishery",catch.type='total',
                                            plot1stObs=FALSE); 
    mdfr2 = rCompTCMs::extractMDFR.Fits.EffectiveNs(models,fleets=flt,
                                                   fleet.type="fishery",category="total");
    for (x_ in c("male","female")){
      obss = mdfr1 |> dplyr::filter(type=="observed",x==x_) |> dplyr::select(case,y,z,val) |> 
               tidyr::pivot_wider(names_from=z,values_from="val");
      prds = mdfr1 |> dplyr::filter(type=="predicted",x==x_) |> dplyr::select(case,y,z,val) |> 
               tidyr::pivot_wider(names_from=z,values_from="val");
      Ns = mdfr2 |> dplyr::filter(type=="input ss",x==x_) |> dplyr::select(case,y,val)
      lst = list();
      for (case_ in cases1){
        #--case_=cases1[1]
        ys  = (obss |> dplyr::filter(case==case_) |> dplyr::select(y))$y;
        obs=as.matrix(obss |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
        names(obs) = ys;
        prd = as.matrix(prds |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
        prd = prd+1.0e-5;
        N   = (Ns   |> dplyr::filter(case==case_) |> dplyr::select(val))$val;
        zs  = as.numeric(colnames(obs));
        res = afscOSA::run_osa(obs,prd,N=N,fleet=case_,index=zs,years=ys,index_label="size (mm CW)");
        lst[[case_]] = res;
      }
      p   = afscOSA::plot_osa(lst)[[1]];
      cap = paste0("OSA residuals for TCSAM02 models fit to ",x_," size compositions from the ",flt,
                   " fishery. ",
                   "The base model is 22.03d5.");
      xt  = paste0(fltnm,"-",x_);
      lbl = wtsQMD::getLabel(xt);
      pth = wtsQMD::getFigFN(xt);
      lstFigs = c(lstFigs,wtsQMD::printGGplot(p,lbl=lbl,cap=cap,pth=pth,ori="L"));
    }#--x_ loop
  }#--flt loop
```

```{r fig_TCSAM02-OSAs-Fsh-RKF}
#| fig-width: 9
#| fig-asp: 0.667
  ##--OSA residuals for RKF fishery data
  cases1 = names(models)
  fltnms = c("TCF"="TCF","SCF"="SCF","RKF"="RKF","GF All"="GFA");
  for (flt in c("RKF")){
    #--testing: flt = "RKF";
    fltnm = fltnms[flt];
    mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets=flt,
                                            fleet.type="fishery",catch.type='total',
                                            plot1stObs=FALSE); 
    mdfr2 = rCompTCMs::extractMDFR.Fits.EffectiveNs(models,fleets=flt,
                                                   fleet.type="fishery",category="total");
    for (x_ in c("male")){#--females fail!!
      #--x_="female";
      obss = mdfr1 |> dplyr::filter(type=="observed",x==x_,y!=2020) |> dplyr::select(case,y,z,val) |> 
               tidyr::pivot_wider(names_from=z,values_from="val");
      prds = mdfr1 |> dplyr::filter(type=="predicted",x==x_,y!=2020) |> dplyr::select(case,y,z,val) |> 
               tidyr::pivot_wider(names_from=z,values_from="val");
      Ns = mdfr2 |> dplyr::filter(type=="input ss",x==x_,y!=2020) |> dplyr::select(case,y,val)
      lst = list();
      for (case_ in cases1){
        #--case_=cases1[4]
        ys  = (obss |> dplyr::filter(case==case_) |> dplyr::select(y))$y;
        obs=as.matrix(obss |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
        rownames(obs) = ys;
        prd = as.matrix(prds |> dplyr::filter(case==case_) |> dplyr::select(!c(case,y)));
        rownames(prd) = ys;
        prd = prd+1.0e-5;
        N   = (Ns   |> dplyr::filter(case==case_) |> dplyr::select(val))$val;
        zs  = as.numeric(colnames(obs));
        res = afscOSA::run_osa(obs,prd,N=N,fleet=case_,index=zs,years=ys,index_label="size (mm CW)");
        lst[[case_]] = res;
      }
      p   = afscOSA::plot_osa(lst)[[1]];
      cap = paste0("OSA residuals for TCSAM02 models fit to ",x_," size compositions from the ",flt,
                   " fishery. ",
                   "The base model is 22.03d5.");
      xt  = paste0("");
      lbl = wtsQMD::getLabel(xt);
      pth = wtsQMD::getFigFN(xt);
      lstFigs = c(lstFigs,wtsQMD::printGGplot(p,lbl=lbl,cap=cap,pth=pth,ori="L"));
    }#--x_ loop
  }#--flt loop
```

<!-- ```{r fig_TCSAM02-FitsZCs} -->
<!-- #| fig-width: 9 -->
<!-- #| fig-asp: 0.667 -->
<!-- #--NMFS EBS surveys-------------------------------------------------- -->
<!-- fltnms = c("NMFS M"="NMFS_M","NMFS F"="NMFS_F"); -->
<!-- for (flt in c("NMFS M","NMFS F")){ -->
<!--   #--testing: flt = "NMFS M"; -->
<!--   fltnm = fltnms[flt]; -->
<!--   mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets=flt, -->
<!--                                           fleet.type="survey",catch.type='index', -->
<!--                                           plot1stObs=FALSE);  -->
<!--   mdfr2 = dplyr::bind_rows(mdfr1 |> dplyr::filter(type=="predicted"), -->
<!--                            mdfr1 |> dplyr::filter((type=="observed")&(case %in% c("22.03d5","25_01")))); -->
<!--   ps = rCompTCMs::compareFits.SizeComps(mdfr=mdfr2, -->
<!--                                         fleets="all", -->
<!--                                         fleet.type="survey",catch.type='index', -->
<!--                                         plot1stObs=FALSE, -->
<!--                                         ncol=5,nrow=2, -->
<!--                                         useBars=FALSE, -->
<!--                                         usePins=TRUE, -->
<!--                                         usePinsAndPts=TRUE, -->
<!--                                         dodge=4); -->
<!--   for (i in 1:length(ps)){ -->
<!--     cap = paste0("TCSAM02 models' fits to survey size compositions in the ",flt," survey. ", -->
<!--                  "The base model is 22.03d5."); -->
<!--     xt  = paste0("ZCs-",fltnm,"-",i); -->
<!--     lbl = wtsQMD::getLabel(xt); -->
<!--     pth = wtsQMD::getFigFN(xt); -->
<!--     lstFigs = c(lstFigs,wtsQMD::printGGplot(ps[[i]],lbl=lbl,cap=cap,pth=pth,ori="L")); -->
<!--   }#--i -->
<!--   rm(ps); -->
<!-- } -->
<!-- rm(flt,fltnms,fltnm,mdfr1,mdfr2); -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig_TCSAM02-RetFitTCF -->
<!-- #| results: "asis" -->
<!-- #| fig-width: 6.0 -->
<!-- #| fig-asp: 1.4 -->
<!-- ##--fisheries (biomass)-------------------------------------------- -->
<!-- plts<-rCompTCMs::compareFits.BiomassData(objs=models, -->
<!--                                          fleets=c("TCF"), -->
<!--                                          fleet.type="fishery", -->
<!--                                          catch.type="retained", -->
<!--                                          ci=0.95); -->

<!-- ##--combined sex---- -->
<!-- pg = cowplot::plot_grid(plts[[2]] + legPosUR + noTitle + noXTitle, -->
<!--                         plts[[3]] + legNone + noTitle + noXTitle,ncol=1); -->
<!-- lbl = wtsQMD::getLabel(); -->
<!-- cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to the directed Tanner crab fishery (TCF) retained catch biomass. ", -->
<!--              "Points and bars indicate the catch values and assumed confidence intervals.") -->
<!-- pth = wtsQMD::getFigFN(); -->

<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P")); -->
<!-- rm(pg,lbl,cap,pth); -->
<!-- ``` -->

<!-- ```{r TCSAM02-GetFisheryCatchBiomassFits} -->
<!-- ##--fisheries (biomass)-------------------------------------------- -->
<!-- plts<-rCompTCMs::compareFits.BiomassData(objs=models, -->
<!--                                          fleets=c("TCF", -->
<!--                                                   "SCF", -->
<!--                                                   "RKF", -->
<!--                                                   "GF All"), -->
<!--                                          fleet.type="fishery", -->
<!--                                          catch.type="total", -->
<!--                                          ci=0.95); -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig_TCSAM02-FshFitTCF -->
<!-- #| results: "asis" -->
<!-- #| fig-width: 6.0 -->
<!-- #| fig-asp: 1.4 -->
<!-- ##--combined sex---- -->
<!-- pg = cowplot::plot_grid(plts[[2]] + legPosUR + noTitle + noXTitle, -->
<!--                         plts[[3]] + legNone + noTitle + noXTitle,ncol=1); -->
<!-- lbl = wtsQMD::getLabel(); -->
<!-- cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to the directed Tanner crab fishery (TCF) combined-sex total catch (retained + discards) biomass. ", -->
<!--              "Points and bars indicate the catch values and assumed confidence intervals.") -->
<!-- pth = wtsQMD::getFigFN(); -->

<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P")); -->
<!-- rm(pg,lbl,cap,pth); -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig_TCSAM02-FshFitSCF -->
<!-- #| results: "asis" -->
<!-- #| fig-width: 6.0 -->
<!-- #| fig-asp: 1.4 -->
<!-- ##--combined sex---- -->
<!-- pg = cowplot::plot_grid(plts[[5]] + legPosUR + noTitle + noXTitle, -->
<!--                         plts[[6]] + legNone + noTitle + noXTitle,ncol=1); -->
<!-- lbl = wtsQMD::getLabel(); -->
<!-- cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to the snow crab fishery (SCF) combined-sex bycatch biomass. ", -->
<!--              "Points and bars indicate the catch values and assumed confidence intervals.") -->
<!-- pth = wtsQMD::getFigFN(); -->

<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P")); -->
<!-- rm(pg,lbl,cap,pth); -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig_TCSAM02-FshFitRKF -->
<!-- #| results: "asis" -->
<!-- #| fig-width: 6.0 -->
<!-- #| fig-asp: 1.4 -->
<!-- ##--combined sex---- -->
<!-- pg = cowplot::plot_grid(plts[[8]] + legPosUR + noTitle + noXTitle, -->
<!--                         plts[[9]] + legNone + noTitle + noXTitle,ncol=1); -->
<!-- lbl = wtsQMD::getLabel(); -->
<!-- cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to the BBRKC fishery (RKF) combined-sex bycatch biomass. ", -->
<!--              "Points and bars indicate the catch values and assumed confidence intervals.") -->
<!-- pth = wtsQMD::getFigFN(); -->

<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P")); -->
<!-- rm(pg,lbl,cap,pth); -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: fig_TCSAM02-FshFitGFA -->
<!-- #| results: "asis" -->
<!-- #| fig-width: 6.0 -->
<!-- #| fig-asp: 1.4 -->
<!-- ##--combined sex---- -->
<!-- pg = cowplot::plot_grid(plts[[11]] + legPosUR + noTitle + noXTitle, -->
<!--                         plts[[12]] + legNone + noTitle + noXTitle,ncol=1); -->
<!-- lbl = wtsQMD::getLabel(); -->
<!-- cap = paste0("Comparison of TCSAM02 (22.03d5) and the alternative TCSAM02 models fits to the groundfish fisheries (GFA) combined-sex bycatch biomass. ", -->
<!--              "Points and bars indicate the catch values and assumed confidence intervals.") -->
<!-- pth = wtsQMD::getFigFN(); -->

<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(pg,pth=pth,lbl=lbl,cap=cap,ori="P")); -->
<!-- rm(pg,lbl,cap,pth,plts); -->
<!-- ``` -->

<!-- ```{r fig_TCSAM02-Fits2Ret} -->
<!-- #| fig-width: 9 -->
<!-- #| fig-asp: 0.667 -->
<!-- #--retained catch size comps-------------------------------------------------- -->
<!--   mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets="TCF", -->
<!--                                           fleet.type="fishery",catch.type='retained', -->
<!--                                           plot1stObs=FALSE);  -->
<!--   mdfr2 = dplyr::bind_rows(mdfr1 |> dplyr::filter(type=="predicted"), -->
<!--                            mdfr1 |> dplyr::filter((type=="observed")&(case %in% c("22.03d5","25_01")))); -->
<!--   ps = rCompTCMs::compareFits.SizeComps(mdfr=mdfr1, -->
<!--                                         fleets="TCF", -->
<!--                                         fleet.type="fishery",catch.type='retained', -->
<!--                                         plot1stObs=FALSE, -->
<!--                                         ncol=5,nrow=2, -->
<!--                                         useBars=FALSE, -->
<!--                                         usePins=TRUE, -->
<!--                                         usePinsAndPts=TRUE, -->
<!--                                         dodge=4); -->
<!--   for (i in 1:length(ps)){ -->
<!--     cap = paste0("TCSAM02 models' fits to retained catch size compositions in the directed fishery. ", -->
<!--                  "The base model is 22.03d5."); -->
<!--     xt  = paste0("ZCs-",fltnm,"-",i); -->
<!--     lbl = wtsQMD::getLabel(xt); -->
<!--     pth = wtsQMD::getFigFN(xt); -->
<!--     lstFigs = c(lstFigs,wtsQMD::printGGplot(ps[[i]],lbl=lbl,cap=cap,pth=pth,ori="L")); -->
<!--   }#--i -->
<!--   rm(ps); -->
<!-- rm(flt,fltnms,fltnm,mdfr1,mdfr2); -->
<!-- ``` -->

<!-- ```{r fig_TCSAM02-Fits2Tot} -->
<!-- #| fig-width: 9 -->
<!-- #| fig-asp: 0.667 -->
<!-- #--total catch size comps-------------------------------------------------- -->
<!--   mdfr1 = rCompTCMs::extractFits.SizeComps(models,fleets="TCF", -->
<!--                                           fleet.type="fishery",catch.type='total', -->
<!--                                           plot1stObs=FALSE);  -->
<!--   mdfr2 = dplyr::bind_rows(mdfr1 |> dplyr::filter(type=="predicted"), -->
<!--                            mdfr1 |> dplyr::filter((type=="observed")&(case %in% c("22.03d5","25_01")))); -->
<!--   ps = rCompTCMs::compareFits.SizeComps(mdfr=mdfr1, -->
<!--                                         fleets="TCF", -->
<!--                                         fleet.type="fishery",catch.type='retained', -->
<!--                                         plot1stObs=FALSE, -->
<!--                                         ncol=5,nrow=2, -->
<!--                                         useBars=FALSE, -->
<!--                                         usePins=TRUE, -->
<!--                                         usePinsAndPts=TRUE, -->
<!--                                         dodge=4); -->
<!--   for (i in 1:length(ps)){ -->
<!--     cap = paste0("TCSAM02 models' fits to total catch size compositions in the directed fishery. ", -->
<!--                  "The base model is 22.03d5."); -->
<!--     xt  = paste0("ZCs-","TCF","-",i); -->
<!--     lbl = wtsQMD::getLabel(xt); -->
<!--     pth = wtsQMD::getFigFN(xt); -->
<!--     lstFigs = c(lstFigs,wtsQMD::printGGplot(ps[[i]],lbl=lbl,cap=cap,pth=pth,ori="L")); -->
<!--   }#--i -->
<!--   rm(ps); -->
<!-- rm(flt,fltnms,fltnm,mdfr1,mdfr2); -->
<!-- ``` -->



<!-- ```{r} -->
<!-- #| label: fig-ModComps-Rec  -->
<!-- #| fig-cap: Comparison of TCSAM02 (22.03d) and GMACS models (G24...) predicted recruitment time series. Results from models 22.03d and G24.06 are highlighted using thicker lines. -->
<!-- #| fig-asp: 0.6 -->
<!-- #--recruitment---- -->
<!-- #--TCSAM02 -->
<!-- dfrT = rCompTCMs::extractMDFR.Pop.Recruitment(models[compare]) |> -->
<!--          dplyr::select(case,y,val,lb=lci,ub=uci); -->
<!-- #--GMACS -->
<!-- dfrG = wtsGMACS::extractRep1Results(reslst,"Summary") |>  -->
<!--           dplyr::filter(!(case %in% noConv)) |>  -->
<!--           dplyr::select(case,y=year,rec_male,`log(rec_male)`,`SD(log(rec_male))`) |> -->
<!--           dplyr::mutate(dplyr::across(2:5,as.numeric)) |>  -->
<!--           dplyr::mutate(val=2*rec_male, -->
<!--                         lb=2*qlnorm(0.10,log(rec_male),`SD(log(rec_male))`), -->
<!--                         ub=2*qlnorm(0.10,log(rec_male),`SD(log(rec_male))`,lower.tail=FALSE) -->
<!--                        ) |>  -->
<!--           dplyr::select(case,y,val,lb,ub); -->
<!-- dfrA = dplyr::bind_rows(dfrT,dfrG);  -->
<!-- p = ggplot(dfrA |> dplyr::filter(y>1981), -->
<!--            mapping=aes(x=y,y=val,ymin=lb,ymax=ub,colour=case,fill=case)) + -->
<!--     geom_line() +  -->
<!--     geom_line(data=dfrA |> dplyr::filter(y>1981,case=="G24_06"),linewidth=1.0) + -->
<!--     geom_line(data=dfrA |> dplyr::filter(y>1981,case=="22.03d"),linewidth=1.0) + -->
<!--     geom_hline(yintercept=0) +  -->
<!--     labs(x="year",y="estimated recruitment (millions)") +  -->
<!--     wtsPlots::getStdTheme(); -->
<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(p)); -->
<!-- rm(p,dfrA,dfrG,dfrT); -->
<!-- ```   -->

<!-- ```{r} -->
<!-- #| label: fig-ModComps-MMB  -->
<!-- #| fig-cap: Comparison of TCSAM02 (22.03d) and GMACS models (G24...) predicted MMB trend. Results from models 22.03d and G24.06 are highlighted using thicker lines. -->
<!-- #| fig-asp: 0.6 -->
<!-- #--MMB---- -->
<!-- #--TCSAM02 -->
<!-- dfrT = rCompTCMs::extractMDFR.Pop.MatureBiomass(models[compare]) |>  -->
<!--          dplyr::filter(x=="male") |>  -->
<!--          dplyr::select(case,y,val,lb=lci,ub=uci); -->
<!-- #--GMACS -->
<!-- dfrG = wtsGMACS::extractRep1Results(reslst,"Summary") |>  -->
<!--           dplyr::filter(!(case %in% noConv)) |>  -->
<!--           dplyr::select(case,y=year,SSB,`log(SSB)`,`SD(log(SSB))`) |> #--this is MMB, right? -->
<!--           dplyr::mutate(dplyr::across(2:5,as.numeric)) |>  -->
<!--           dplyr::mutate(val=SSB, -->
<!--                         lb=qlnorm(0.10,log(SSB),`SD(log(SSB))`), -->
<!--                         ub=qlnorm(0.10,log(SSB),`SD(log(SSB))`,lower.tail=FALSE) -->
<!--                        ) |>  -->
<!--           dplyr::select(case,y,val,lb,ub); -->
<!-- dfrA = dplyr::bind_rows(dfrT,dfrG);  -->
<!-- p = ggplot(dfrA |> dplyr::filter(y>1981), -->
<!--            mapping=aes(x=y,y=val,ymin=lb,ymax=ub,colour=case,fill=case)) + -->
<!--     geom_line() +  -->
<!--     geom_line(data=dfrA |> dplyr::filter(y>1981,case=="G24_06"),linewidth=1.0) + -->
<!--     geom_line(data=dfrA |> dplyr::filter(y>1981,case=="22.03d"),linewidth=1.0) + -->
<!--     geom_hline(yintercept=0) +  -->
<!--     labs(x="year",y="estimated MMB (1,000's t)") +  -->
<!--     wtsPlots::getStdTheme(); -->
<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(p)); -->
<!-- rm(p,dfrA,dfrG,dfrT); -->
<!-- ```   -->


<!-- ```{r} -->
<!-- #| label: fig-ModComps-PopAbd  -->
<!-- #| fig-cap: Comparison of TCSAM02 (22.03d) and GMACS models (G24...) predicted population abundance trends by sex and maturity state. Results from models 22.03d and G24.06 are highlighted using thicker lines. -->
<!-- #| fig-asp: 1.2 -->
<!-- #--Population abundance---- -->
<!-- #--TCSAM02 -->
<!-- dfrT = rCompTCMs::extractMDFR.Pop.Abundance(models[compare],cast="x+m") |>  -->
<!--          dplyr::select(case,y,x,m,val); -->
<!-- #--GMACS -->
<!-- dfrG = wtsGMACS::extractRep1Results(reslst,"N_YXMSZ") |>  -->
<!--                 dplyr::filter(!(case %in% noConv)) |>  -->
<!--                 tidyr::pivot_longer(cols=!c(case,year,sex,maturity,shell_con), -->
<!--                                     names_to="size", -->
<!--                                     values_to="est") |>  -->
<!--                 dplyr::mutate(dplyr::across(c(year,size,est), -->
<!--                                             as.numeric), -->
<!--                               xm=paste(maturity,sex) -->
<!--                              ) |>  -->
<!--                dplyr::group_by(case,year,sex,maturity) |>  -->
<!--                dplyr::summarize(val=sum(est)) |>  -->
<!--                dplyr::ungroup() |>  -->
<!--                dplyr::select(case,y=year,x=sex,m=maturity,val); -->
<!-- dfrA = dplyr::bind_rows(dfrT,dfrG);  -->
<!-- p = ggplot(dfrA |> dplyr::filter(y>1981), -->
<!--            mapping=aes(x=y,y=val,colour=case,fill=case)) + -->
<!--     geom_line() +  -->
<!--     geom_line(data=dfrA |> dplyr::filter(y>1981,case=="G24_06"),linewidth=1.0) + -->
<!--     geom_line(data=dfrA |> dplyr::filter(y>1981,case=="22.03d"),linewidth=1.0) + -->
<!--     geom_hline(yintercept=0) +  -->
<!--     facet_wrap(~paste(m,x),ncol=1,scales="free_y") +  -->
<!--     labs(x="year",y="estimated abundance (millions)") +  -->
<!--     wtsPlots::getStdTheme(); -->
<!-- lstFigs = c(lstFigs,wtsQMD::printGGplot(p)); -->
<!-- rm(p,dfrA,dfrG,dfrT); -->
<!-- ```   -->

<!-- references -->
```{r,eval=!knitr::opts_knit$get("child")&!isPDF,results='asis'}
  cat("# References {-}\n");
  cat("::: {#refs}\n");
  cat(":::\n\n");
```

<!-- tables, if not child doc and lstTbls is not empty -->
```{r}
#| label: tables_TCSAM02
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printTablesSectionFromList.R",package="wtsQMD"));
```

<!-- figures, if not child doc and lstFigs is not empty -->
```{r}
#| label: figures_TCSAM02
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printFiguresSectionFromList.R",package="wtsQMD"));
```
